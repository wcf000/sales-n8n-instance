name: CI

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [develop, main]

env:
  PYTHON_VERSION: '3.11'
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}

jobs:
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies with uv
        working-directory: api-bridge
        run: |
          uv sync --all-extras --dev --no-cache

      - name: Run pre-commit hooks
        run: |
          cd api-bridge
          uv run pre-commit run --all-files --verbose || true
        continue-on-error: true

      - name: Lint with Ruff
        working-directory: api-bridge
        run: |
          uv run ruff check . --fix || true
          uv run ruff format --check . || true

      - name: Format check with Black
        working-directory: api-bridge
        run: |
          uv run black --check --diff . || true
        continue-on-error: true

      - name: Type check with mypy
        working-directory: api-bridge
        run: |
          uv run mypy . --ignore-missing-imports || true
        continue-on-error: true

  test:
    name: Test Python Code
    runs-on: ubuntu-latest
    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgresql://test:test@localhost:5432/test_db
      N8N_URL: http://localhost:5678
      N8N_API_KEY: test-key

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies with uv
        working-directory: api-bridge
        run: |
          uv sync --all-extras --dev

      - name: Run tests with coverage
        working-directory: api-bridge
        run: |
          uv run pytest tests/ -v --maxfail=1 --disable-warnings --cov=. --cov-report=term-missing --cov-report=xml || true
        continue-on-error: true

      - name: Upload coverage to Codecov (optional)
        if: always()
        uses: codecov/codecov-action@v4
        with:
          file: ./api-bridge/coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        continue-on-error: true

  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build n8n image
        uses: docker/build-push-action@v5
        with:
          context: ./n8n
          file: ./n8n/Dockerfile
          push: false
          tags: n8n-custom:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build API bridge image
        uses: docker/build-push-action@v5
        with:
          context: ./api-bridge
          file: ./api-bridge/Dockerfile
          push: false
          tags: api-bridge:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify images
        run: |
          docker images | grep -E "(n8n-custom|api-bridge)"
          docker inspect n8n-custom:ci
          docker inspect api-bridge:ci

